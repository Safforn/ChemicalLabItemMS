<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="renderer" content="webkit">

    <title>出库表单</title>
    <meta name="keywords">
    <meta name="description">

    <link href="css/bootstrap.min.css?v=3.4.0" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.css?v=4.3.0" rel="stylesheet">
    <link href="css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css?v=2.2.0" rel="stylesheet">
</head>
<body>
<div id="wrapper">
    <!-- 侧边栏 -->
    <div id="left_sidebar"></div>
    <div id="page-wrapper" class="gray-bg dashbard-1">
        <!--头部-->
        <div id="header"></div>
        <!--标题-->
        <div class="row wrapper border-bottom white-bg page-heading">
            <div class="col-lg-10">
                <h2>领用/借用出库</h2>

            </div>
            <div class="col-lg-2">

            </div>
        </div>

        <!-- 所有表单元素  -->
        <div class="wrapper wrapper-content animated fadeInRight">
            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>领用/借用申请表</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <form method="get" class="form-horizontal">

                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="ibox float-e-margins">

                                            <div class="ibox-content">

                                                <table id="table" class="datatable table table-striped table-bordered table-hover">

                                                </table>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>


                    </div>
                </div>
            </div>
        </div>

        <!-- 数据表单弹窗 -->
        <form method="post" class="form-horizontal" role="form" id="updateGoodsForm">
            <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
                <div class="modal-dialog" style="width: 1400px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                ×
                            </button>
                            <h4 class="modal-title" id="updateModalLabel">
                                物品清单
                            </h4>
                        </div>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="ibox float-e-margins">
                                        <div class="ibox-content">


                                            <form method="get" class="form-horizontal">
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">备注</label>
                                                    <div class="col-sm-10">
                                                        <textarea  id="text-wh" class="form-control input-lg m-b" name="saysths" rows="5" cols="30" wrap="soft" style="resize:none;">备注</textarea>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-lg-12">
                                                            <div class="ibox float-e-margins">
                                                                <div class="ibox-title">
                                                                    <h5>出库物品清单</h5>
                                                                    <div class="ibox-tools">
                                                                        <a class="collapse-link">
                                                                            <i class="fa fa-chevron-up"></i>
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                                <div class="ibox-content">

                                                                    <table id="listTable" width="100%" class="table table-striped table-bordered table-hover dataTables-example">

                                                                    </table>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-4 col-sm-offset-2">
                                                        <button class="btn btn-primary" type="submit" onclick="ex_submit()">出库</button>
                                                    </div>
                                                </div>
                                            </form>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--   end modal-body  -->

                </div><!-- /.modal-content -->
            </div><!-- /.modal -->

        </form>



    </div>
</div>


<!-- Mainly scripts -->
<script src="js/jquery-2.1.1.min.js"></script>
<script src="js/bootstrap.min.js?v=3.4.0"></script>
<script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="js/hplus.js?v=2.2.0"></script>
<script src="js/plugins/pace/pace.min.js"></script>

<!-- iCheck -->
<script src="js/plugins/iCheck/icheck.min.js"></script>

<!--&lt;!&ndash;引入JavaScript&ndash;&gt;-->
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>


<!-- Data Tables -->
<script src="js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="js/plugins/dataTables/dataTables.bootstrap.js"></script>

<!--&lt;!&ndash;引入css&ndash;&gt;-->
<!--<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css">-->

<!--&lt;!&ndash;&lt;!&ndash;引入JavaScript&ndash;&gt;&ndash;&gt;-->
<!--<script type="text/javascript" language="javascript" src="//code.jquery.com/jquery-1.12.4.js"></script>-->
<!--<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>-->

<!-- Page-Level Scripts -->


<!--初始化代码-->
<!-- 导入header -->
<script>
    $(function () {
        $.get("header.html",function (data) {
            $("#header").html(data);
        });
    });
</script>
<script>
    $(function () {
        $.get("left_sidebar.html",function (data) {
            $("#left_sidebar").html(data);
        });
    });
</script>
<script>
    var temp_user_id;
    var temp_data;
    var borrow_order_id;

    console.log("--flag-1-");

    $.ajax({
        async: false,
        type : "post",
        url : "user/findOne",
        success : function(user) {
            console.log("--flag-findOne-");
            temp_user_id = user.user_id;
            console.log("user.user_id"+user.user_id);
        }
    });

    // 初始化，获取首页表格数据
    $.ajax({
        async: false,
        data: {user_id: temp_user_id},
        type : "post",
        url : "ex/initBorrowTable",
        success : function(data) {
            console.log("--flag-inittable-");
            temp_data=data.data;
        }
    });
    console.log("|temp_data=\n"+temp_data);

    function json2Array(jsonData, list_or_not) {
        var jsonsString = jsonData.slice(1, jsonData.length - 1);
        var jsonStrings = jsonsString.split("},");
        var length = jsonStrings.length;
        var jsons = [];
        for (var i = 0; i !== length-1; ++i) {
            jsonStrings[i] += '}';
        }
        var source = [[]];
        for (var i = 0; i !== length; ++i) {
            //console.log("$"+jsonStrings[i]);
            jsons[i] = eval('(' + jsonStrings[i] + ')');
            var data = [];
            for(var key in jsons[i]) {
                if(i === 0) {
                    source[0].push(key);
                }
                //console.log("i="+i+"|key="+key+"|json[i,key]="+jsons[i][key]);
                if(!list_or_not || key !== "purpose"  ) {
                    if (key !== "type") {
                        data.push(jsons[i][key]);
                    }
                } else {
                    console.log("跳过在执行一次")
                }
            }
            source.push(data);
        }
        return source.slice(1); //删除第1行
    }
    //console.log("temp_data=\n"+temp_data);
    temp_data = json2Array(temp_data, true);

    // 时间格式纠正
    function formatDate(ms, format = 'YYYY-MM-DD hh:mm:ss') {
        const date = new Date(ms);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hours = date.getHours();
        const minutes = date.getMinutes();
        const seconds = date.getSeconds();

        const map = {
            'YYYY': year,
            'MM': addPrefixZero(month),
            'M': month,
            'DD': addPrefixZero(day),
            'D': day,
            'hh': addPrefixZero(hours),
            'h': hours,
            'mm': addPrefixZero(minutes),
            'm': minutes,
            'ss': addPrefixZero(seconds),
            's': seconds,
        };

        let result = format;
        for (const key in map) {
            result = result.replace(key, map[key]);
        }
        return result;
    }

    // 在个位数字前面添加 0，使得数字位数为两位
    function addPrefixZero(num) {
        return num < 10 ? '0' + num : num;
    }

    var start_dateTime;
    var end_dateTime;
    var requisition_dateTime;
    // console.log('date:'+formatDate(1684570394000));
    for (var i = 0; i !== temp_data.length; ++i) {
        console.log("#"+i+"#"+temp_data[i][3]);
        start_dateTime = formatDate(Number(eval(temp_data[i][3])));
        end_dateTime = formatDate(Number(eval(temp_data[i][4])));
        // console.log("转数字"+Number(temp_data[i][3]));
        temp_data[i][3] = start_dateTime;
        temp_data[i][4] = end_dateTime;
    }
    // console.log("@@@"+requisition_dateTime);

    console.log("|temp_data_CHANGED=\n"+temp_data);


    const dataSets = [ ];
    $(document).ready(function() {
        $(function(){
            var table = $('#table').DataTable({
                retrieve: true,
                data:temp_data,
                columns:[
                    {
                        'field': "purchase_requisition_id",
                        'title': '领用/借用申请表编号',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "purchase_order_id",
                        'title': '领用/借用物品清单编号',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "requisition_user_id",
                        'title': '申请人',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    },  {
                        'field': "requisition_date",
                        'title': '借用开始日期',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    },{
                        'field': "requisition_date",
                        'title': '借用结束日期',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        field: "operate",
                        sTitle: '操作',
                        sDefaultContent :
                            "<button class='list-btn btn btn-primary btn-xs' type='button' style='margin-left: 10px'>出库</button>",
                        sClass: 'text-center',
                        "data" : null,
                        // "render" : function(data, type,row) {
                        //     var id = '"' + row.id + '"';
                        //     var html = "<a href='javascript:void(0);'  class='btn btn-primary btn-xs'  onclick='EditViewById()'></i>物品清单</a>"
                        //     return html;
                        //     // formatter: actionFormatter
                        // }
                    }],
                "language": {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 项结果",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                    "oAria": {
                        "sSortAscending": ": 以升序排列此列",
                        "sSortDescending": ": 以降序排列此列"
                    }
                }
            });

            var temp_list_data;
            var temp_order_id;  // 本条订单的order——id

            // 点击 物品清单
            $("table tbody").on("click",".list-btn",function (){
                // TODO: 待办 - 进入物品清单弹窗，刷新表单
                //$('#listTable').dataTable().api().draw();

                var tds=$(this).parents("tr").children();
                temp_order_id = tds[1].innerText;
                borrow_order_id = tds[1].innerText;
                //console.log("temp_order_id"+temp_order_id);
                $.ajax({
                    async: true,  // true 同步，false异步
                    data: {order_id: temp_order_id},
                    type: "post",
                    url : "ex/searchOneByOrderId",
                    success : function(data) {
                        //console.log("--flag-initListTable-");
                        temp_list_data=data.data;
                        temp_list_data = json2Array(temp_list_data, true)
                    }
                });

                $('#updateModal').modal('show');  // 显示弹窗表格
                // 更新表格数据
                $('#listTable').dataTable().api().clear();
                $('#listTable').dataTable().api().rows.add(temp_list_data);
                $('#listTable').dataTable().api().draw();


                $('#updateModal').modal('show');
            })

            var listtable = $('#listTable').DataTable({
                retrieve: true,
                data:dataSets,
                columns:[
                    {
                        'field': "name",
                        'title': '物品id',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    },{
                        'field': "name",
                        'title': '物品名称',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "specification",
                        'title': '规格',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "quantity",
                        'title': '数量',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "unit",
                        'title': '包装单位',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "classification",
                        'title': '分类',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "price",
                        'title': '单价',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "expiration_time",
                        'title': '过期时间',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "upper_limit",
                        'title': '警戒上限',
                        // width:90,
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "lower_limit",
                        'title': '警戒下限',
                        // width:90,
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "warehouse_id",
                        'title': '仓库',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "notes",
                        'title': '备注',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }],
                "language": {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 项结果",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                    "oAria": {
                        "sSortAscending": ": 以升序排列此列",
                        "sSortDescending": ": 以降序排列此列"
                    }
                }
            });


        });

    } );

    //点击出库按钮
    function ex_submit(){
        if(confirm('确认出库？')){
            //点击确认
            var notes = $('#text-wh').val();

            var front_end_data =
                'ex_order_id='+borrow_order_id+'&'+ 'notes='+notes;

            // 把前端数据传给后端
            $.post("ex/exWarehouse", front_end_data, function (data) {
                console.log("在接受后端数据之后");
                if (data.flag) {
                    alert("提交成功");
                } else {
                    alert("提交失败");
                }
            })

        }else{
            //点击取消

        }
    }

</script>



</body>
</html>