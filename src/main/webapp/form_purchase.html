<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="renderer" content="webkit">

    <title>采购申请表</title>
    <meta name="keywords" >
    <meta name="description" >
    <link href="css/bootstrap.min.css?v=3.4.0" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.css?v=4.3.0" rel="stylesheet">
    <link href="css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css?v=2.2.0" rel="stylesheet">
</head>
<body>
<!--<button type="button" id="batch-edit-btn">批量编辑</button>-->
<!--<button type="button" id="batch-save-btn">批量保存</button>-->
<!--<table id="table" class="display" width="100%"></table>-->
<div id="wrapper">
    <!-- 侧边栏 -->
    <div id="left_sidebar"></div>

    <div id="page-wrapper" class="gray-bg dashbard-1">
        <div class="row border-bottom">
            <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
                <div class="navbar-header">
                    <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="form_basic.html#"><i class="fa fa-bars"></i> </a>
                    <form role="search" class="navbar-form-custom" method="post" action="search_results.html">
                        <div class="form-group">
                            <input type="text" placeholder="请输入您需要查找的内容 …" class="form-control" name="top-search" id="top-search">
                        </div>
                    </form>
                </div>
                <ul class="nav navbar-top-links navbar-right">
                    <li>
                        <span class="m-r-sm text-muted welcome-message"><a href="index.html" title="返回首页"><i class="fa fa-home"></i></a>欢迎使用H+后台主题</span>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle count-info" data-toggle="dropdown" href="index.html#">
                            <i class="fa fa-envelope"></i>  <span class="label label-warning">16</span>
                        </a>
                        <ul class="dropdown-menu dropdown-messages">
                            <li>
                                <div class="dropdown-messages-box">
                                    <a href="profile.html" class="pull-left">
                                        <img alt="image" class="img-circle" src="img/a7.jpg">
                                    </a>
                                    <div class="media-body">
                                        <small class="pull-right">46小时前</small>
                                        <strong>小四</strong> 项目已处理完结
                                        <br>
                                        <small class="text-muted">3天前 2014.11.8</small>
                                    </div>
                                </div>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <div class="dropdown-messages-box">
                                    <a href="profile.html" class="pull-left">
                                        <img alt="image" class="img-circle" src="img/a4.jpg">
                                    </a>
                                    <div class="media-body ">
                                        <small class="pull-right text-navy">25小时前</small>
                                        <strong>国民岳父</strong> 这是一条测试信息
                                        <br>
                                        <small class="text-muted">昨天</small>
                                    </div>
                                </div>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <div class="text-center link-block">
                                    <a href="mailbox.html">
                                        <i class="fa fa-envelope"></i>  <strong> 查看所有消息</strong>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle count-info" data-toggle="dropdown" href="index.html#">
                            <i class="fa fa-bell"></i>  <span class="label label-primary">8</span>
                        </a>
                        <ul class="dropdown-menu dropdown-alerts">
                            <li>
                                <a href="mailbox.html">
                                    <div>
                                        <i class="fa fa-envelope fa-fw"></i> 您有16条未读消息
                                        <span class="pull-right text-muted small">4分钟前</span>
                                    </div>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="profile.html">
                                    <div>
                                        <i class="fa fa-qq fa-fw"></i> 3条新回复
                                        <span class="pull-right text-muted small">12分钟钱</span>
                                    </div>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <div class="text-center link-block">
                                    <a href="notifications.html">
                                        <strong>查看所有 </strong>
                                        <i class="fa fa-angle-right"></i>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </li>


                    <li>
                        <a href="login.html">
                            <i class="fa fa-sign-out"></i> 退出
                        </a>
                    </li>
                </ul>

            </nav>
        </div>
        <div class="row wrapper border-bottom white-bg page-heading">
            <div class="col-lg-10">
                <h2>采购申请</h2>
                <ol class="breadcrumb">
                    <li>
                        <a href="index.html">主页</a>
                    </li>
                    <li>
                        <a>表单</a>
                    </li>
                    <li>
                        <strong>采购申请</strong>
                    </li>
                </ol>
            </div>
            <div class="col-lg-2">

            </div>
        </div>
        <div class="wrapper wrapper-content animated fadeInRight">
            <!-- 采购申请表的基本信息 元素 -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>采购申请单</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <form method="get" class="form-horizontal">

                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="ibox float-e-margins">

                                            <div class="ibox-content">
                                                <div class="">
                                                    <a onclick="fnClickAddRow();" href="javascript:void(0);" class="btn btn-primary ">新建采购申请</a>
                                                    <button type="button" id="batch-edit-btn" class="btn btn-primary ">批量编辑</button>
                                                    <button type="button" id="batch-save-btn" class="btn btn-primary ">批量保存</button>
                                                </div>

                                                <!-- TODO: 主界面表格体 -->
                                                <table id="table" class="datatable table table-striped table-bordered table-hover">
                                                </table>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <!-- 底部按钮组 -->
                        <div class="ibox-content">
                            <form method="get" class="form-horizontal">
                                <div class="hr-line-dashed"></div>
                                <div class="form-group">
                                    <div class="col-sm-4 col-sm-offset-2" style="margin-left: 1000px">
                                        <button id="btn-save-requisition" class="btn btn-primary" type="submit">保存</button>
                                        <button id="btn-submit-requisition" class="btn btn-primary" type="submit">提交</button>
                                        <button id="btn-cancel-requisition" class="btn btn-white" type="submit">取消</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- 数据表单弹窗 -->
        <form method="post" class="form-horizontal" role="form" id="updateGoodsForm">
            <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
                <div class="modal-dialog" style="width: 1400px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                ×
                            </button>
                            <h4 class="modal-title" id="updateModalLabel">
                                物品清单
                            </h4>
                        </div>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="ibox float-e-margins">
                                        <div class="ibox-content">

                                            <div class="">
                                                <a onclick="listfnClickAddRow();" href="javascript:void(0);" class="btn btn-primary ">添加物品</a>
                                                <button type="button" id="list-batch-edit-btn" class="btn btn-primary ">批量编辑</button>
                                                <button type="button" id="list-batch-save-btn" class="btn btn-primary ">批量保存</button>
                                            </div>
                                            <!-- TODO: 弹窗表格本体 -->
                                            <table id=listTable width="100%" class="table table-striped table-bordered table-hover dataTables-example">

                                            </table>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--   end modal-body  -->

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <input type="submit" class="btn btn-primary" id="updateGoods" value="更新"/>
                    </div>

                </div><!-- /.modal-content -->
            </div><!-- /.modal -->

        </form>



    </div>
</div>




<!-- Mainly scripts -->
<script src="js/jquery-2.1.1.min.js"></script>
<script src="js/bootstrap.min.js?v=3.4.0"></script>
<script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="js/hplus.js?v=2.2.0"></script>
<script src="js/plugins/pace/pace.min.js"></script>

<!-- iCheck -->
<script src="js/plugins/iCheck/icheck.min.js"></script>

<!--&lt;!&ndash;引入JavaScript&ndash;&gt;-->
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>


<!-- Data Tables -->
<script src="js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="js/plugins/dataTables/dataTables.bootstrap.js"></script>

<!--&lt;!&ndash;引入css&ndash;&gt;-->
<!--<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css">-->

<!--&lt;!&ndash;&lt;!&ndash;引入JavaScript&ndash;&gt;&ndash;&gt;-->
<!--<script type="text/javascript" language="javascript" src="//code.jquery.com/jquery-1.12.4.js"></script>-->
<!--<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>-->



<!--初始化代码-->
<script>
    $(function () {
        $.get("left_sidebar.html",function (data) {
            $("#left_sidebar").html(data);
        });
    });
</script>
<script>
    const dataSet = [
        ['', '', '', '采购用途0', '', '0'],
        ['', '', '', '采购用途1', '', '0'],
    ];
    const dataSets = [
        ['aaa1', '规格1', '20', '单位', 'fenlei', '10.0', '2000-12-24', '300', '20', '1hao', 'beizhu'],
        ['aaa2', '规格', '20', '单位', 'fenlei', '10.0', '2000-12-24', '300', '20', '1hao', 'beizhu'],
        ['aaa3', '规格1', '20', '单位', 'fenlei', '10.0', '2000-12-24', '300', '20', '1hao', 'beizhu'],
        ['aaa4', '规格', '20', '单位', 'fenlei', '10.0', '2000-12-24', '300', '20', '1hao', 'beizhu'],
        ['aaa5', '规格1', '20', '单位', 'fenlei', '10.0', 'xxxx-xx', '300', '20', '1hao', 'beizhu']

    ];
    $(document).ready(function() {
        $(function(){
            // 主页面表格（申请表）
            var table = $('#table').DataTable({
                retrieve: true,
                data:dataSet,
                columns:[
                    {
                        'field': "purchase_requisition_id",
                        'title': '采购申请表编号',
                        'defaultContent' : ""
                    }, {
                        'field': "purchase_order_id",
                        'title': '采购物品清单编号',
                        'defaultContent' : ""
                    }, {
                        'field': "requisition_user_id",
                        'title': '申请人',
                        'defaultContent' : ""
                    }, {
                        'field': "purpose",
                        'title': '采购用途',
                        'defaultContent' : ""
                    }, {
                        'field': "requisition_date",
                        'title': '申请提交日期',
                        'defaultContent' : ""
                    }, {
                        'field': "state",
                        'title': '申请当前状态',
                        'defaultContent' : "0"
                    }, {
                        'field': "approval_user_id",
                        'title': '审批人',
                        'defaultContent' : ""
                    }, {
                        'field': "approval_opinions",
                        'title': '审批意见',
                        'defaultContent' : ""
                    }, {
                        'field': "approval_date",
                        'title': '审批日期',
                        'defaultContent' : ""
                    }, {
                        field: "operate",
                        sTitle: '操作',
                        sDefaultContent : "<button class='submit-btn btn btn-primary btn-xs' type='button' >提交</button>"+
                            "<button class='edit-btn btn btn-primary btn-xs' type='button' style='margin-left: 10px'>编辑</button>"  +
                        "<button class='list-btn btn btn-primary btn-xs' type='button' style='margin-left: 10px'>物品清单</button>"+
                            "<button class='delete btn btn-default btn-xs' style='margin-left: 10px'>删除</button>",
                        sClass: 'text-center',
                        "data" : null,
                        // "render" : function(data, type,row) {
                        //     var id = '"' + row.id + '"';
                        //     var html = "<a href='javascript:void(0);'  class='btn btn-primary btn-xs'  onclick='EditViewById()'></i>物品清单</a>"
                        //     return html;
                        //     // formatter: actionFormatter
                        // }
                    }],
                "language": {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 项结果",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                    "oAria": {
                        "sSortAscending": ": 以升序排列此列",
                        "sSortDescending": ": 以降序排列此列"
                    }
                }
            });
            // 弹窗表格（物品清单）
            var listtable = $('#listTable').DataTable({
                retrieve: true,
                data:dataSets,
                columns:[
                    {
                        'field': "name",
                        'title': '物品名称',
                        'defaultContent' : "-",
                        'sClass': 'text-center'
                    }, {
                        'field': "specification",
                        'title': '规格',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "quantity",
                        'title': '数量',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "unit",
                        'title': '包装单位',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "classification",
                        'title': '分类',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "price",
                        'title': '单价',
                        'defaultContent' : "0",
                        'sClass': 'text-center'
                    }, {
                        'field': "expiration_time",
                        'title': '过期时间',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "upper_limit",
                        'title': '警戒上限',
                        // width:90,
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "lower_limit",
                        'title': '警戒下限',
                        // width:90,
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "warehouse_id",
                        'title': '仓库',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        'field': "notes",
                        'title': '备注',
                        'defaultContent' : "",
                        'sClass': 'text-center'
                    }, {
                        field: "operate",
                        sTitle: '操作',
                        sDefaultContent : "<button class='list-edit-btn btn btn-primary btn-xs' type='button'>编辑</button>" +
                            "<button class='list-delete btn btn-default btn-xs' style='margin-left: 10px'>删除</button>",
                        sClass: 'text-center',
                        // width:100,
                        "data" : null,
                        // "render" : function(data, type,row) {
                        //   var html = "<a href='javascript:void(0);'  class='edit-btn btn btn-primary btn-xs' type='button'>修改</a>"
                        //   // TODO: 按钮的修改功能
                        //   html += "<a href='javascript:void(0);'  class='delete btn btn-default btn-xs'>删除</a>"
                        //   return html;
                        //   // formatter: actionFormatter
                        // }
                    }],
                "language": {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 项结果",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                    "oAria": {
                        "sSortAscending": ": 以升序排列此列",
                        "sSortDescending": ": 以降序排列此列"
                    }
                }
            });

            //点击物品清单
            $("table tbody").on("click",".list-btn",function (){
                $('#updateModal').modal('show');
            })

            //点击提交按钮
            $("table tbody").on("click",".submit-btn",function (){
                var tds = $(this).parents("tr").children();
                // 拼后端BeanUtils所需的map串
                var front_end_data = "";
                if (tds[0].innerText !== "") front_end_data += "purchase_requisition_id="+tds[0].innerText+"&";
                if (tds[1].innerText !== "") front_end_data += "purchase_order_id="+tds[1].innerText+"&";
                if (tds[3].innerText !== "") front_end_data += "purpose="+tds[3].innerText+"&";
                if (tds[4].innerText !== "") front_end_data += "requisition_date="+tds[4].innerText+"&";
                if (tds[5].innerText !== "") front_end_data += "&state="+tds[5].innerText+"&";
                if (tds[6].innerText !== "") front_end_data += "&approval_user_id="+tds[6].innerText+"&";
                if (tds[7].innerText !== "") front_end_data += "&approval_opinions="+tds[7].innerText+"&";
                if (tds[8].innerText !== "") front_end_data += "&approval_date="+tds[8].innerText+"&";
                // front_end_data = front_end_data.substring(0, front_end_data.length-1);  //删除最后一个字符

                $.get("user/findOne", {}, function (data) {
                    // 获取当前登陆的用户id
                    front_end_data += "requisition_user_id="+data.user_id;
                    console.log("front_end_data="+front_end_data);
                    // 把前端数据传给后端
                    $.post("purchase/createOrUpdateItems", front_end_data, function (data) {
                        console.log("在接受后端数据之后");
                        alert("后端返回"+data.flag);
                    })
                });
            })

            // 申请表修改
            $("#table tbody").on("click",".edit-btn",function(){
                var tds=$(this).parents("tr").children();
                $.each(tds, function(i,val){
                    var jqob=$(val);
                    if(i<=2||i>3 ){return true;}//跳过第1项 序号,按钮
                    var txt=jqob.text();
                    var put=$("<input type='text' style='width: 80px'>");
                    put.val(txt);
                    jqob.html(put);
                });
                $(this).html("保存");
                $(this).toggleClass("edit-btn");
                $(this).toggleClass("save-btn");
            });

            // 申请表保存
            $("#table tbody").on("click",".save-btn",function(){
                var row=table.row($(this).parents("tr"));
                var tds=$(this).parents("tr").children();
                $.each(tds, function(i,val){
                    var jqob=$(val);
                    //把input变为字符串
                    console.log(!jqob.has('button').length);
                    if(!jqob.has('button').length){
                        var txt=jqob.children("input").val();
                        // console.log(jqob.children("input"));
                        jqob.html(txt);
                        table.cell(jqob).data(txt);//修改DataTables对象的数据
                    }
                });




                $(this).html("编辑");
                $(this).toggleClass("edit-btn");
                $(this).toggleClass("save-btn");
            });

            // 物品清单修改
            $("#listTable tbody").on("click",".list-edit-btn",function(){
                var tds=$(this).parents("tr").children();
                $.each(tds, function(i,val){
                    var jqob=$(val);
                    if(jqob.has('button').length ){return true;}//跳过第1项 序号,按钮
                    var txt=jqob.text();
                    var put=$("<input type='text' style='width: 80px'>");
                    put.val(txt);
                    jqob.html(put);
                });
                $(this).html("保存");
                $(this).toggleClass("list-edit-btn");
                $(this).toggleClass("list-save-btn");
            });

            //物品清单修改保存
            $("#listTable tbody").on("click",".list-save-btn",function(){
                var row=listtable.row($(this).parents("tr"));
                var tds=$(this).parents("tr").children();
                $.each(tds, function(i,val){
                    var jqob=$(val);
                    //把input变为字符串
                    //console.log(!jqob.has('button').length);
                    if(!jqob.has('button').length){
                        var txt=jqob.children("input").val();
                        console.log(jqob.children("input"));
                        jqob.html(txt);
                        listtable.cell(jqob).data(txt);//修改DataTables对象的数据
                    }
                });
                $(this).html("编辑");
                $(this).toggleClass("list-edit-btn");
                $(this).toggleClass("list-save-btn");
            });

            //批量点击编辑按钮
            $("#batch-edit-btn").click(function(){
                $(".edit-btn").click();
            });
            $("#batch-save-btn").click(function(){
                $(".save-btn").click();
            });

            //物品清单批量点击编辑按钮
            $("#list-batch-edit-btn").click(function(){
                $(".list-edit-btn").click();
            });
            $("#list-batch-save-btn").click(function(){
                $(".list-save-btn").click();
            });

            // 申请单点击删除按钮，触发删除行脚本
            $(document).on("click",'.delete',function(){
                $('#table').dataTable().fnDeleteRow($(this).closest('tr')[0]);
            });
            // 物品清单点击删除按钮，触发删除行脚本
            $(document).on("click",'.list-delete',function(){
                $('#listTable').dataTable().fnDeleteRow($(this).closest('tr')[0]);
            });
        });
    } );

</script>

<script>
    function fnClickAddRow() {
        $('#table').dataTable().fnAddData([
            "", "", "", "",
            "", "", "", "", "",
            "", ""]);}
    function listfnClickAddRow() {
        $('#listTable').dataTable().fnAddData([
            "", "", "", "",
            "", "", "", "", "",
            "", ""]);}
</script>

</body>
</html>